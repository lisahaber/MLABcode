---
title: "data QCQA"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(dplyr)
library(plotly)
library(ggplot2)
```

```{r, echo=FALSE}
# Load data - CREATE AS INIT FILE

# Inputs
basepath <- "/Volumes/GoogleDrive/My Drive/UBC/Micromet Lab/database"
yrs <- 2021 #c(2019:2022)
site <- "BB2"
level <- "L3"
vars <- c("wind_dir","wind_speed","u_","pitch","year","w_var")
export <- 0 

# Create dataframe for years & variables of interest
# Path to function to load data
source("/Users/sara/Library/CloudStorage/OneDrive-UBC/UBC/MLABcode/database_functions/read_database.R")

data <- load.export.data(basepath,yrs,site,level,vars,export)

# Remove missing data (should be -9999 so FIX eventually)
data <- replace(data, data == -9999, NA)
```

Sonic data
=======================================================================

Column {data-width=600}
-----------------------------------------------------------------------

### Sonic variables and diagnostics

```{r}
var <- c("wind_dir","wind_speed","u_","pitch")
unit <- c("degrees","m/s","m/s","degrees")

plots <- plot.new()
  for (i in 1:length(var)){
plots[[i]] <- plot_ly(data, x = ~datetime, y = as.formula(paste0("~", var[i]))) %>%
    add_lines(name = var[i])%>% 
    layout(yaxis = list(title = unit[i]))%>%
    toWebGL()
  }

subplot(plots, nrows = length(plots), shareX = TRUE, titleX = FALSE,titleY = TRUE)%>% layout(legend = list(orientation = 'h'))

# Custom figures - Add Max/Min & identify outliers

```

Column {data-width=400}
-----------------------------------------------------------------------

### mean wind speed vs. u*
```{r}
sumtbl <- summary(lm(u_ ~ wind_speed,data = data))
slope <- sumtbl$coefficients[2]
r2 <- sumtbl$adj.r.squared

p <- ggplot(data, aes(x=wind_speed, y=u_,na.rm = TRUE)) + 
  geom_point(aes(color = factor(year),na.rm = TRUE),alpha = 0.6)+
  geom_smooth(method=lm, color = "black",na.rm = TRUE)+
  ggtitle(paste("Slope = ",as.character(round(slope,2)),", R2 = ",as.character(round(r2,2))))+
  theme(plot.title = element_text(color = "grey44"))+
  theme(plot.title = element_text(size = 8))
ggplotly(p)%>%
  toWebGL()
```


### sigma_w vs. u*
```{r}
sumtbl <- summary(lm(sqrt(w_var) ~ u_,data = data))
slope <- sumtbl$coefficients[2]
r2 <- sumtbl$adj.r.squared

p <- ggplot(data, aes(x=u_, y=sqrt(w_var))) + 
  geom_point(aes(color = factor(year)),alpha = 0.6)+
  geom_smooth(method=lm, color = "black")+
  ggtitle(paste("Slope = ",as.character(round(slope,2)),", R2 = ",as.character(round(r2,2))))+
  theme(plot.title = element_text(color = "grey44"))+
  theme(plot.title = element_text(size = 8))
ggplotly(p)%>%
  toWebGL()
```

Temperature data
=======================================================================

Row
-------------------------------------------------------------------

### Air temperature comparison


Row
-----------------------------------------------------------------------

### Chart B

```{r}

```

