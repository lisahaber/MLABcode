---
title: "data_QCQA"
output:
  html_document:
    df_print: paged
header-includes:
  - \usepackage{float}
  - \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
require("knitr")
require("dplyr")
require("lubridate")
require("ggplot2")
require("kableExtra")
require("plotly")
require("htmlwidgets")
knitr::opts_chunk$set(fig.pos = "H")
knitr::opts_knit$set(root.dir = "/Volumes/GoogleDrive/My Drive/UBC/Micromet Lab/Projects/2014-BB1 Burns Bog/Flux-tower/flux_data") 
```

```{r, echo=FALSE}
# Load data 

# Data 
file <- "BB_combined.csv"
data <- read.csv(file, header = T)

# Create datetime
data$DATE <- as.POSIXct(data$DATE, format="%Y-%m-%d %H:%M:%S", tz="UTC")

vars <- c("H","LE")
plots <- lapply(vars, function(var) {
  plot_ly(data, x = ~DATE, y = as.formula(paste0("~", var))) %>%
    add_lines(name = var)
})
subplot(plots, nrows = length(plots), shareX = TRUE, titleX = FALSE)

```


```{r, echo=FALSE}
# Plot sonic data

# Wind direction
plot_ly(data = data, x = ~DATE, y = ~wind_dir, type = 'scatter', mode = 'markers') %>%
    layout(yaxis = list(title = "Degree"))


  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# Wind speed
plot_ly(data = data, x = ~datetime, y = ~wind_speed, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# ustar
plot_ly(data = data, x = ~datetime, y = ~ustar, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# Sonic, irgas and air temperature
plot_ly(data = data, x = ~datetime, y = ~sonic_temperature, type = 'scatter', mode = 'markers', name = 'sonic temperature') %>% 
    add_trace(data = data, x = ~datetime, y = ~TA_1_1_1, type = 'scatter', mode = 'markers', name = 'HMP temperature') %>%
    add_trace(data = data, x = ~datetime, y = ~air_t_mean, type = 'scatter', mode = 'markers', name = 'air_t_mean') %>% 
    add_trace(data = data, x = ~datetime, y = ~air_temperature, type = 'scatter', mode = 'markers', name = 'air_temperature') %>%
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

plot_ly(data = data, x = ~TA_1_1_1, y = ~sonic_temperature, type = 'scatter', mode = 'markers') %>%
  toWebGL()
    
# pitch
plot_ly(data = data, x = ~datetime, y = ~pitch, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))
```

```{r, echo=FALSE}
# Plot ch4 data & diagnostics

#RSSI
plot_ly(data = data, x = ~datetime, y = ~rssi_77_mean, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# CH4 concentration
plot_ly(data = data, x = ~datetime, y = ~ch4_mixing_ratio, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# CH4 flux
plot_ly(data = data, x = ~datetime, y = ~ch4_flux*1000, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))
```

```{r, echo=FALSE}
# Plot CO2 data & diagnostics

#SS
plot_ly(data = data, x = ~datetime, y = ~avg_signal_strength_7200_mean, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# Flow rate
plot_ly(data = data, x = ~datetime, y = ~flowrate_mean*60000, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# pressure fluctuations
plot_ly(data = data, x = ~datetime, y = ~delta_p_LI_7200, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# thermocouple temps
plot_ly(data = data, x = ~datetime, y = ~t_out_LI_7200, type = 'scatter', mode = 'markers',name = "t_out_LI_7200") %>% 
    add_trace(
    data = data, x = ~datetime, y = ~t_in_LI_7200, type = 'scatter', mode = 'markers',name = "t_in_LI_7200") %>%
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# CO2 concentration
plot_ly(data = data, x = ~datetime, y = ~co2_mixing_ratio, type = 'scatter', mode = 'markers',color = ~qc_co2_flux) %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# CO2 flux
plot_ly(data = data, x = ~datetime, y = ~co2_flux, type = 'scatter', mode = 'markers',color = ~qc_co2_flux) %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))
```

```{r, echo=FALSE}
# RH
plot_ly(data = data, x = ~datetime, y = ~RH_1_1_1, type = 'scatter', mode = 'markers',name = "RH_1_1_1") %>% 
  add_trace(
    data = data, x = ~datetime, y = ~e/es*100, type = 'scatter', mode = 'markers',name = "RH") %>% # 7200 RH?
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))
```

```{r, echo=FALSE}
# Pressure
plot_ly(data = data, x = ~datetime, y = ~air_pressure, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))
```

```{r, echo=FALSE}
# H and LE
plot_ly(data = data, x = ~datetime, y = ~H, type = 'scatter', mode = 'markers',name = "H") %>% 
    add_trace(
    data = data, x = ~datetime, y = ~LE, type = 'scatter', mode = 'markers',name = "LE") %>%
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

#G
plot_ly(data = data, x = ~datetime, y = ~SHF_1_1_1, type = 'scatter', mode = 'markers',name = "SHF 1") %>% 
    add_trace(
    data = data, x = ~datetime, y = ~SHF_2_1_1, type = 'scatter', mode = 'markers',name = "SHF 2") %>%
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))
```

```{r, echo=FALSE}
# Radiation & humidity/precip

# PRECIP
plot_ly(data = data, x = ~datetime, y = ~P_RAIN_1_1_1, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))


# Radiation components
plot_ly(data = data, x = ~datetime, y = ~SWIN_1_1_1, type = 'scatter', mode = 'markers',name = "SW_IN") %>% 
    add_trace(
    data = data, x = ~datetime, y = ~SWOUT_1_1_1, type = 'scatter', mode = 'markers',name = "SW_OUT") %>%
add_trace(
    data = data, x = ~datetime, y = ~LWIN_1_1_1, type = 'scatter', mode = 'markers',name = "LW_IN") %>%
add_trace(
    data = data, x = ~datetime, y = ~LWOUT_1_1_1, type = 'scatter', mode = 'markers',name = "LW_OUT") %>%
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# Calculate net radiation
data <- data %>%
  mutate(NETRAD = (SWIN_1_1_1-SWOUT_1_1_1)+(LWIN_1_1_1-LWOUT_1_1_1))

# NETRAD
plot_ly(data = data, x = ~datetime, y = ~NETRAD, type = 'scatter', mode = 'markers') %>% 
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

# SW_IN vs PPFD
# Radiation components
plot_ly(data = data, x = ~datetime, y = ~PPFD_1_1_1, type = 'scatter', mode = 'markers',name = "PPFD_IN") %>% 
    add_trace(
    data = data, x = ~datetime, y = ~SWIN_1_1_1, type = 'scatter', mode = 'markers',name = "SW_OUT") %>%
  toWebGL() %>%
layout(xaxis = list(range = c(min(data$datetime), max(data$datetime))))

plot_ly(data = data, x = ~PPFD_1_1_1, y = ~SWIN_1_1_1, type = 'scatter', mode = 'markers',name = "PPFD_IN") %>% 
  toWebGL() 

lm.rad <- lm(formula = PPFD_1_1_1 ~ SWIN_1_1_1, data = data)
summary(lm.rad)
```

```{r, echo=FALSE}
# Energy balance closure
ggplot(data, aes(x=NETRAD, y=H+LE)) + 
  geom_point()+
  geom_smooth(method=lm)

lm.EBC <- lm(formula = H+LE ~ NETRAD, data = data)
summary(lm.EBC)
```
